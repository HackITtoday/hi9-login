<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../firebase-element/firebase-auth.html">
<link rel="import" href="../firebase-element/firebase-document.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../paper-styles/demo-pages.html">
<link rel="import" href="../neon-animation/neon-animations.html">

<dom-module id="hi9-login">
  <template>
    <firebase-auth id="firebaseLogin" user="{{user}}" status-known="{{statusKnown}}" location="https://hi9site.firebaseio.com" provider="google" on-error="errorHandler" on-user-created="userSuccessHandler" on-password-changed="userSuccessHandler" on-password-reset="userSuccessHandler" on-user-removed="userSuccessHandler"></firebase-auth>
    <firebase-document location="https://hi9site.firebaseio.com/data/" id="firebaseDocument"></firebase-document>
    
    <paper-button on-tap="logout" hidden$="{{computeLogoutHidden(statusKnown, user)}}">Logout</paper-button>
    <paper-button on-tap="login" hidden$="{{computeLoginHidden(statusKnown, user)}}" >Login</paper-button>

</template>
</dom-module>
<script>
  Polymer({
    is: 'hi9-login',
    properties: {
      provider: {
        type: String,
        value: 'anonymous'
      },
      message: {
        type: String,
        value: ''
      },
      email: {
        type: String,
        value: ''
      },
      password: {
        type: String,
        value: ''
      },
      user: {
        type: Object,
        value: null
      },
      statusKnown: {
        type: Boolean
      },
      show_model: {
        type: Boolean,
        notify: true,
        computed: "computeLogoutHidden(statusKnown, user)"
      }
    },
    login: function() {
      var params;
      try {
        params = JSON.parse(this.params);
      } catch (e) {
        params = null;
      }
      if (this.provider == 'password') {
        params = params || {};
        params.email = this.email;
        params.password = this.password;
      }
      this.$.firebaseLogin.login(params);
      this.log("Login");
    },
    logout: function() {
      this.log("Logout");
      this.$.firebaseLogin.logout();
    },
    errorHandler: function(e) {
      this.message = 'Error: ' + e.detail.message;
    },
    userSuccessHandler: function(e) {
      this.message = e.type + ' success!';
    },
    createUserHandler: function(e) {
      this.$.firebaseLogin.createUser(this.email, this.password);
    },
    changePasswordHandler: function(e) {
      this.$.firebaseLogin.changePassword(this.email, this.password, this.newPassword);
    },
    resetPasswordHandler: function(e) {
      this.$.firebaseLogin.sendPasswordResetEmail(this.email);
    },
    computePasswordHidden: function(provider) {
      return provider !== 'password';
    },
    computeCreateUserDisabled: function(email, password) {
      return !email || !password;
    },
    computeChangePasswordDisabled: function(email, password, newPassword) {
      return !email || !password || !newPassword;
    },
    computeResetPasswordDisabled: function(email, password) {
      return !email || !password;
    },
    computeRemoveUserDisabled: function(email, password) {
      return !email || !password;
    },
    computeLoginHidden: function(statusKnown, user) {
      return !statusKnown || !!user;
    },
    computeLogoutHidden: function(statusKnown, user) {
      return !statusKnown || !user;
    },
    computeLoginStatus: function(statusKnown, user) {
      var d = new Date();
      var n = d.getTime();
      
      this.log("Login Status");
      
      if (statusKnown && user) {
        return 'Logged in';
      }
      if (statusKnown) {
        return 'Logged out';
      }
      return 'Unknown (checking status...)';
    },
    log: function(log) {
      var d = new Date();
      var n = d.getTime();
      var user = this.user;
      this.$.firebaseDocument.query.ref().push({log: log,time:n,user:user});
    }
  });
</script>
