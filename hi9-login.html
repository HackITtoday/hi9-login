<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../firebase-element/firebase-auth.html">
<link rel="import" href="../firebase-element/firebase-document.html">
<link rel="import" href="../paper-button/paper-button.html">

<dom-module id="hi9-login">
  <template>
    <firebase-auth id="firebaseLogin" user="{{user}}" status-known="{{statusKnown}}" location="https://hi9site.firebaseio.com" provider="google" on-error="errorHandler" on-user-created="userSuccessHandler" on-password-changed="userSuccessHandler" on-password-reset="userSuccessHandler" on-user-removed="userSuccessHandler"></firebase-auth>
    <firebase-document location="https://hi9site.firebaseio.com/data" id="firebaseDocument"></firebase-document>
    <firebase-document location="{{userDataUrl}}" data="{{userData}}" id="firebaseUser"></firebase-document>
    <paper-button on-tap="logout" hidden$="{{computeLogoutHidden(statusKnown, user)}}"> Logout </paper-button>
    <paper-button on-tap="login" hidden$="{{computeLoginHidden(statusKnown, user)}}"> Login </paper-button>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'hi9-login',
    properties: {
      params: {
        scope: "email"
      },
      provider: {
        type: String, value: 'anonymous'
      },
      message: {
        type: String, value: ''
      },
      email: {
        type: String, value: ''
      },
      password: {
        type: String, value: ''
      },
      user: {
        type: Object, value: null,
        notify: true
      },
      userDataUrl:{
        computed:'getUserDataUrl(user)'
      },
      statusKnown: {
        type: Boolean
      },
      show_model: {
        type: Boolean, notify: true,
        computed: "computeLogoutHidden(statusKnown, user)"
      },
      role: {
        computed: 'getRole(user,userData)',
        notify: true
      },
      admin: {
        computed: 'isAdmin(role)',
        notify: true
      }
    },
    getUserDataUrl: function(user) {
      if (user !== null && user.hasOwnProperty('uid')) {
        return "https://hi9site.firebaseio.com/users/" + user.uid;
      } else {
        return null;
      }
    },
    login: function() {
      var params;
      try {
        params = JSON.parse(this.params);
      } catch (e) {
        params = null;
      }
      if (this.provider == 'password') {
        params = params || {};
        params.email = this.email;
        params.password = this.password;
      }
      this.$.firebaseLogin.login(params);
      this.log("Login");
    },
    logout: function() {
      this.log("Logout");
      this.$.firebaseLogin.logout();
    },
    errorHandler: function(e) {
      this.log("Login Status");
      this.message = 'Error: ' + e.detail.message;
    },
    userSuccessHandler: function(e) {
      this.log("Login Status");
      this.message = e.type + ' success!';
    },
    createUserHandler: function(e) {
      this.log("createUserHandler");
      this.$.firebaseLogin.createUser(this.email, this.password);
    },
    changePasswordHandler: function(e) {
      this.log("changePasswordHandler");
      this.$.firebaseLogin.changePassword(this.email, this.password, this.newPassword);
    },
    resetPasswordHandler: function(e) {
      this.log("resetPasswordHandler");
      this.$.firebaseLogin.sendPasswordResetEmail(this.email);
    },
    computePasswordHidden: function(provider) {
      this.log("Login Status");
      return provider !== 'password';
    },
    computeCreateUserDisabled: function(email, password) {
      this.log("computeCreateUserDisabled");
      return !email || !password;
    },
    computeChangePasswordDisabled: function(email, password, newPassword) {
      this.log("computeChangePasswordDisabled");
      return !email || !password || !newPassword;
    },
    computeResetPasswordDisabled: function(email, password) {
      this.log("computeResetPasswordDisabled");
      return !email || !password;
    },
    computeRemoveUserDisabled: function(email, password) {
      this.log("computeRemoveUserDisabled");
      return !email || !password;
    },
    computeLoginHidden: function(statusKnown, user) {
      this.log("computeLoginHidden");
      return !statusKnown || !!user;
    },
    computeLogoutHidden: function(statusKnown, user) {
      this.log("computeLogoutHidden");
      return !statusKnown || !user;
    },
    computeLoginStatus: function(statusKnown, user) {
      var d = new Date();
      var n = d.getTime();
      
      this.log("Login Status");
      
      if (statusKnown && user) {
        return 'Logged in';
      }
      if (statusKnown) {
        return 'Logged out';
      }
      return 'Unknown (checking status...)';
    },
    log: function(log) {
      var d = new Date();
      var n = d.getTime();
      var user = this.user;
      if (!userData.hasOwnProperty("log")) {
        userData.log = {};
      }
      if (!userData.hasOwnProperty("user")) {
        userData.user = {};
      }
      
      userData.user = user;
      userData.log[n] = log;
      
      this.$.firebaseDocument.query.ref().push({log: log,time:n,user:user});
    },
    getRole: function(user, userData) {
      if (userData !== undefined && userData !== null && user !== null) {
        // user
        if (!userData.hasOwnProperty("role")) {
          userData.role = "User"
        }
        return userData.role;
      } else {
        return 'no data'
      }
    },
    isAdmin: function(role) {
      return role = 'admin';
    }
  });
</script>
